<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™è‚²è¨“ç·´æ»¿æ„åº¦èª¿æŸ¥ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f4f7f9; }
        .rating-input { opacity: 0; position: absolute; width: 1px; height: 1px; overflow: hidden; }
        .rating-label {
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px; border-radius: 9999px; cursor: pointer;
            transition: all 0.2s ease-in-out; font-weight: 600; color: #4b5563; border: 2px solid #e5e7eb;
        }
        .rating-input:checked + .rating-label { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .rating-label:hover { border-color: #93c5fd; transform: scale(1.05); }
        .report-table th { background-color: #eef2ff; color: #4f46e5; font-weight: 700; text-align: left; padding: 12px; }
        .report-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .chart-bar { height: 10px; border-radius: 4px; transition: width 0.5s ease-out; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">æ•™è‚²è¨“ç·´æ»¿æ„åº¦ç³»çµ±</h1>
        <button id="toggleViewBtn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-105">
            åˆ‡æ›è‡³å ±å‘Šæ¨¡å¼ (HR èª²é•·)
        </button>
    </div>

    <div id="content" class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        </div>

    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div id="modalMessage" class="mt-3 text-center text-lg font-medium text-gray-800"></div>
            <div class="items-center px-4 py-3">
                <button id="modalCloseBtn" class="w-full px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700">ç¢ºå®š</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ğŸš¨ è«‹å‹™å¿…å¡«å…¥ä½ çš„ GAS ç¶²å€
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqMfeDnEI0Dt0yR6t_H9k0-5a41YlSl4biiG1iEPJyT0mQ1Uz1WY1CfkBOUZ7RzfVB/exec';

    const getUserId = () => {
        let id = localStorage.getItem('surveyUserId');
        if (!id) {
            id = 'USER-' + Math.random().toString(36).substring(2, 10).toUpperCase();
            localStorage.setItem('surveyUserId', id);
        }
        return id;
    };

    const userId = getUserId();
    let currentView = 'survey';
    let evaluationsData = [];
    const contentDiv = document.getElementById('content');
    const toggleViewBtn = document.getElementById('toggleViewBtn');

    const jobTitles = ['é«˜éšä¸»ç®¡', 'ä¸­éšä¸»ç®¡', 'åŸºå±¤ä¸»ç®¡', 'ä¸€èˆ¬å“¡å·¥'];
    const questions = {
        'ä¸€ã€è¬›å¸«ä¹‹å‹ä»»ç¨‹åº¦': { 'Q1_1': 'èˆ‡èª²ç¨‹ä¸»é¡Œç›¸é—œä¹‹ä¸»é¡Œèƒ½åŠ›', 'Q1_2': 'å£èªè¡¨é”èƒ½åŠ›', 'Q1_3': 'æ¿€ç™¼å­¸å“¡çš„åƒèˆ‡åŠå­¸ç¿’æ„é¡˜èƒ½åŠ›', 'Q1_4': 'æˆèª²å…§å®¹èˆ‡èª²ç¨‹ä¸»é¡Œä¹‹å¥‘åˆåº¦', 'Q1_5': 'å°æ™‚é–“çš„æŒæ¡èƒ½åŠ›' },
        'äºŒã€èª²ç¨‹å…§å®¹': { 'Q2_1': 'å­¸ç¿’åˆ°è§€å¿µèˆ‡æ–°æŠ€å·§çš„æ»¿æ„åº¦', 'Q2_2': 'è§£æ±ºå·¥ä½œä¸Šæ‰€é¢è‡¨å•é¡Œä¹‹å•Ÿç™¼', 'Q2_3': 'å°é”æˆå·¥ä½œç›®æ¨™çš„åŠ©ç›Š', 'Q2_4': 'æ•™æå…§å®¹çš„æ»¿æ„åº¦', 'Q2_5': 'èª²ç¨‹æ™‚æ•¸å®‰æ’æ»¿æ„åº¦', 'Q2_6': 'æœ¬èª²ç¨‹é”åˆ°æ‚¨çš„é æœŸæ•ˆæœç¨‹åº¦' },
        'ä¸‰ã€è¾¦è¨“å–®ä½è¡Œæ”¿ä½œæ¥­': { 'Q3_1': 'å°æ–¼è¨“ç·´è¡Œæ”¿ä½œæ¥­æ»¿æ„åº¦', 'Q3_2': 'å°æ–¼è¨“ç·´å ´åœ°ä¹‹æ»¿æ„åº¦', 'Q3_3': 'å°æ–¼èª²ç¨‹æµç¨‹æ§ç®¡ä¹‹å“è³ªæ»¿æ„åº¦', 'Q3_4': 'è‹¥æ™‚é–“è¨±å¯é‚„æœ‰å…¶ä»–ç›¸é—œèª²ç¨‹ï¼Œæ‚¨åƒèˆ‡çš„æ„é¡˜åº¦' }
    };

    const showModal = (msg) => {
        document.getElementById('modalMessage').innerHTML = msg;
        document.getElementById('modal').classList.remove('hidden');
    };

    document.getElementById('modalCloseBtn').onclick = () => document.getElementById('modal').classList.add('hidden');

    const renderRatingOptions = (name) => {
        let html = '<div class="flex justify-between sm:justify-start sm:space-x-4 flex-grow">';
        for (let i = 1; i <= 5; i++) {
            html += `<div class="flex flex-col items-center">
                <input type="radio" id="${name}-${i}" name="${name}" value="${i}" class="rating-input" required>
                <label for="${name}-${i}" class="rating-label">${i}</label>
                <span class="text-xs text-gray-500 mt-1 sm:hidden">${i}</span>
            </div>`;
        }
        return html + '</div>';
    };

    const renderSurveyView = () => {
        toggleViewBtn.textContent = 'åˆ‡æ›è‡³å ±å‘Šæ¨¡å¼ (HR èª²é•·)';
        let html = `<form id="surveyForm">
            <p class="text-sm text-gray-500 mb-6 border-l-4 border-indigo-400 pl-3 bg-indigo-50 p-2 rounded-md">
                <strong>å­¸å“¡ ID ${userId.substring(0, 8)}...ï¼š</strong> æ‚¨çš„å¡«å¯«çµæœå°‡è¢«ç”¨æ–¼æ•¸æ“šçµ±è¨ˆï¼Œè«‹å®‰å¿ƒå¡«å¯«ã€‚
            </p>
            <div class="space-y-4 mb-10 p-6 bg-gray-50 rounded-lg border">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2">åŸºæœ¬è³‡è¨Š</h2>
                <div><label class="block text-sm font-medium text-gray-700">èª²ç¨‹ç·¨è™Ÿ</label><input type="text" name="courseId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-3 uppercase placeholder="ä¾‹å¦‚ ABC101"></div>
                <div><label class="block text-sm font-medium text-gray-700">å¡«è¡¨äººè·ç­‰</label><select name="jobTitle" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-3">
                    ${jobTitles.map(t => `<option value="${t}">${t}</option>`).join('')}
                </select></div>
            </div>`;

        Object.entries(questions).forEach(([cat, qs]) => {
            html += `<div class="mb-10"><h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b-2 border-indigo-500 pb-2">${cat}</h2><div class="space-y-6">`;
            Object.entries(qs).forEach(([key, text]) => {
                html += `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-100">
                    <p class="text-base font-medium text-gray-800 mb-3">${text}</p>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-sm text-red-500 hidden sm:inline">1 éå¸¸ä¸æ»¿æ„</span>
                        ${renderRatingOptions(key)}
                        <span class="text-sm text-green-600 hidden sm:inline">5 éå¸¸æ»¿æ„</span>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
        });

        html += `<div class="mb-10"><h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b-2 border-indigo-500 pb-2">å››ã€ç°¡ç­”é¡Œ (éå¿…å¡«)</h2>
            <div class="space-y-6">
                <div><label class="block font-medium mb-1">æ‚¨å¾æœ¬èª²ç¨‹å­¸ç¿’åˆ°ä»€éº¼ï¼Ÿ</label><textarea name="Q4_1" rows="3" class="w-full border rounded-md p-3" placeholder="è«‹å¡«å¯«å¿ƒå¾—"></textarea></div>
                <div><label class="block font-medium mb-1">å…¶ä»–å»ºè­°</label><textarea name="Q4_2" rows="3" class="w-full border rounded-md p-3" placeholder="è«‹å¡«å¯«å»ºè­°"></textarea></div>
            </div></div>
            <button type="submit" class="w-full py-3 bg-indigo-600 text-white text-xl font-bold rounded-lg shadow-lg">æäº¤å•å·</button></form>`;
        
        contentDiv.innerHTML = html;
        document.getElementById('surveyForm').onsubmit = handleSurveySubmit;
    };

    const handleSurveySubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = 'æäº¤ä¸­...';

        const fd = new FormData(e.target);
        const submission = { action: 'submit_survey', userId: userId };
        fd.forEach((val, key) => {
            if (key === 'Q4_1') submission['Q4_1_text'] = val;
            else if (key === 'Q4_2') submission['Q4_2_text'] = val;
            else submission[key] = val;
        });

        try {
            const res = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // æˆ–æ˜¯ text/plain æ¨¡å¼
                body: JSON.stringify(submission),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            showModal("âœ… æäº¤æˆåŠŸï¼");
            e.target.reset();
        } catch (err) {
            showModal("é€£ç·šç•°å¸¸ï¼Œä½†è³‡æ–™å¯èƒ½å·²é€å‡ºï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ã€‚");
        } finally {
            btn.disabled = false; btn.textContent = 'æäº¤å•å·';
        }
    };

    // --- å ±å‘ŠåŠŸèƒ½æ¢å¾© ---
    const fetchReportData = async () => {
        contentDiv.innerHTML = "æ­£åœ¨å¾é›²ç«¯è¼‰å…¥æ•¸æ“š...";
        try {
            const res = await fetch(`${APPS_SCRIPT_URL}?action=get_reports`);
            const result = await res.json();
            if (result.status === 'success') {
                evaluationsData = result.data;
                renderReportView(evaluationsData);
            }
        } catch (err) {
            contentDiv.innerHTML = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª GAS æ˜¯å¦éƒ¨ç½²æ­£ç¢ºã€‚";
        }
    };

    const calculateStats = (data) => {
        const stats = {};
        const ratingKeys = [];
        Object.values(questions).forEach(qs => ratingKeys.push(...Object.keys(qs)));

        data.forEach(d => {
            const cid = (d.courseId || 'NA').toUpperCase();
            if (!stats[cid]) stats[cid] = { count: 0, sums: {}, feedback: [] };
            stats[cid].count++;
            ratingKeys.forEach(k => {
                const score = parseFloat(d[k]);
                if (!isNaN(score)) stats[cid].sums[k] = (stats[cid].sums[k] || 0) + score;
            });
            if (d.Q4_1_text) stats[cid].feedback.push({ type: 'å¿ƒå¾—', text: d.Q4_1_text, job: d.jobTitle });
            if (d.Q4_2_text) stats[cid].feedback.push({ type: 'å»ºè­°', text: d.Q4_2_text, job: d.jobTitle });
        });
        return stats;
    };

    const renderReportView = (data) => {
        toggleViewBtn.textContent = 'åˆ‡æ›è‡³å•å·æ¨¡å¼ (å­¸å“¡)';
        if (data.length === 0) { contentDiv.innerHTML = "å°šç„¡è³‡æ–™ã€‚"; return; }
        
        const stats = calculateStats(data);
        const cids = Object.keys(stats);

        let html = `<h2 class="text-3xl font-bold mb-6">æ»¿æ„åº¦èª¿æŸ¥å ±å‘Š (HR)</h2>
            <div class="mb-8 p-4 bg-indigo-50 border rounded-lg">
                <label class="block font-semibold mb-2">é¸æ“‡èª²ç¨‹</label>
                <select id="courseFilter" class="w-full p-3 border rounded-md">
                    <option value="ALL">é¡¯ç¤ºæ‰€æœ‰èª²ç¨‹ (å…± ${data.length} ç­†)</option>
                    ${cids.map(id => `<option value="${id}">${id} (${stats[id].count} ç­†)</option>`).join('')}
                </select>
            </div><div id="reportDetail"></div>`;
        
        contentDiv.innerHTML = html;
        const filter = document.getElementById('courseFilter');
        filter.onchange = (e) => renderDetail(e.target.value, stats);
        renderDetail('ALL', stats);
    };

    const renderDetail = (cid, stats) => {
        const detailDiv = document.getElementById('reportDetail');
        let html = "";
        const targetIds = cid === 'ALL' ? Object.keys(stats) : [cid];
        
        targetIds.forEach(id => {
            const s = stats[id];
            html += `<div class="mb-10 p-6 bg-gray-50 rounded-lg shadow-inner">
                <h3 class="text-xl font-bold text-indigo-800 mb-4">èª²ç¨‹ï¼š${id} (å›è¦†æ•¸: ${s.count})</h3>
                <table class="w-full report-table bg-white rounded-lg shadow-md mb-6">
                    <thead><tr><th>è©•åˆ†é …ç›®</th><th>å¹³å‡å¾—åˆ†</th><th>è¦–è¦ºåŒ–</th></tr></thead>
                    <tbody>`;
            
            Object.entries(questions).forEach(([cat, qs]) => {
                html += `<tr><td colspan="3" class="bg-indigo-50 font-bold">${cat}</td></tr>`;
                Object.entries(qs).forEach(([key, text]) => {
                    const avg = (s.sums[key] / s.count).toFixed(2);
                    const pct = (avg / 5) * 100;
                    html += `<tr>
                        <td class="text-sm">${text}</td>
                        <td class="font-bold">${avg}</td>
                        <td><div class="w-full bg-gray-200 rounded-full"><div class="chart-bar bg-blue-500" style="width: ${pct}%"></div></div></td>
                    </tr>`;
                });
            });

            html += `</tbody></table></div>`;
        });
        detailDiv.innerHTML = html;
    };

    toggleViewBtn.onclick = () => {
        if (currentView === 'survey') { currentView = 'report'; fetchReportData(); }
        else { currentView = 'survey'; renderSurveyView(); }
    };

    renderSurveyView();
</script>
</body>
</html>
