<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™è‚²è¨“ç·´æ»¿æ„åº¦èª¿æŸ¥èˆ‡å ±å‘Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f4f7f9;
        }
        /* éš±è—åŸç”Ÿ Radio Button ä½†ä¿ç•™åŠŸèƒ½ */
        .rating-input {
            opacity: 0;
            position: absolute;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        /* æ¨¡æ“¬ Radio Button æ¨£å¼ */
        .rating-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            color: #4b5563; /* Gray-600 */
            border: 2px solid #e5e7eb; /* Gray-200 */
        }
        .rating-input:checked + .rating-label {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .rating-label:hover {
            border-color: #93c5fd; /* Blue-300 */
            transform: scale(1.05);
        }

        /* è®“ Report é é¢çš„è¡¨æ ¼æ›´å¥½çœ‹ */
        .report-table th, .report-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-table th {
            background-color: #eef2ff; /* Indigo-50 */
            font-weight: 700;
            color: #4f46e5; /* Indigo-600 */
        }
        .report-table tr:last-child td {
            border-bottom: none;
        }
        .report-table tbody tr:hover {
            background-color: #f9fafb;
        }
        .chart-bar {
            height: 20px;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">æ•™è‚²è¨“ç·´æ»¿æ„åº¦ç³»çµ±</h1>
        <button id="toggleViewBtn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out transform hover:scale-105">
            åˆ‡æ›è‡³å ±å‘Šæ¨¡å¼ (HR èª²é•·)
        </button>
    </div>

    <div id="content" class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <div class="flex justify-center items-center h-48">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-xl text-gray-600">ç³»çµ±è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div id="modalMessage" class="mt-3 text-center text-lg font-medium text-gray-800"></div>
            <div class="items-center px-4 py-3">
                <button id="modalCloseBtn" class="w-full px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // ----------------------------------------------------------------------
    // --- ğŸš¨ é‡è¦è¨­å®šï¼šGoogle Apps Script Web App URL ---
    // !!! è«‹å‹™å¿…å°‡ä¸‹æ–¹çš„ä½”ä½ç¬¦æ›¿æ›ç‚ºæ‚¨éƒ¨ç½² Google Apps Script å¾Œç²å¾—çš„å¯¦éš› /exec URL !!!
    // ----------------------------------------------------------------------
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqMfeDnEI0Dt0yR6t_H9k0-5a41YlSl4biiG1iEPJyT0mQ1Uz1WY1CfkBOUZ7RzfVB/exec'; // <-- æ›¿æ›æ­¤è™•ç‚ºæ‚¨çš„çœŸå¯¦ URL

    // ç‚ºäº†æ¨¡æ“¬ç”¨æˆ¶ IDï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹åŸºæ–¼ç€è¦½å™¨çš„ ID
    const getUserId = () => {
        let id = localStorage.getItem('surveyUserId');
        if (!id) {
            id = 'USER-' + Math.random().toString(36).substring(2, 10).toUpperCase();
            localStorage.setItem('surveyUserId', id);
        }
        return id;
    };

    let userId = getUserId(); 
    let currentView = 'survey'; // 'survey' or 'report'
    let evaluationsData = []; // Store all evaluations for report

    const contentDiv = document.getElementById('content');
    const toggleViewBtn = document.getElementById('toggleViewBtn');

    // è·ç­‰é¸é …
    const jobTitles = [
        'é«˜éšä¸»ç®¡',
        'ä¸­éšä¸»ç®¡',
        'åŸºå±¤ä¸»ç®¡',
        'ä¸€èˆ¬å“¡å·¥'
    ];

    // å•å·å•é¡Œå®šç¾©
    const questions = {
        'ä¸€ã€è¬›å¸«ä¹‹å‹ä»»ç¨‹åº¦': {
            'Q1_1': 'èˆ‡èª²ç¨‹ä¸»é¡Œç›¸é—œä¹‹ä¸»é¡Œèƒ½åŠ›',
            'Q1_2': 'å£èªè¡¨é”èƒ½åŠ›',
            'Q1_3': 'æ¿€ç™¼å­¸å“¡çš„åƒèˆ‡åŠå­¸ç¿’æ„é¡˜èƒ½åŠ›',
            'Q1_4': 'æˆèª²å…§å®¹èˆ‡èª²ç¨‹ä¸»é¡Œä¹‹å¥‘åˆåº¦',
            'Q1_5': 'å°æ™‚é–“çš„æŒæ¡èƒ½åŠ›',
        },
        'äºŒã€èª²ç¨‹å…§å®¹': {
            'Q2_1': 'å­¸ç¿’åˆ°è§€å¿µèˆ‡æ–°æŠ€å·§çš„æ»¿æ„åº¦',
            'Q2_2': 'è§£æ±ºå·¥ä½œä¸Šæ‰€é¢è‡¨å•é¡Œä¹‹å•Ÿç™¼',
            'Q2_3': 'å°é”æˆå·¥ä½œç›®æ¨™çš„åŠ©ç›Š',
            'Q2_4': 'æ•™æå…§å®¹çš„æ»¿æ„åº¦',
            'Q2_5': 'èª²ç¨‹æ™‚æ•¸å®‰æ’æ»¿æ„åº¦',
            'Q2_6': 'æœ¬èª²ç¨‹é”åˆ°æ‚¨çš„é æœŸæ•ˆæœç¨‹åº¦',
        },
        'ä¸‰ã€è¾¦è¨“å–®ä½è¡Œæ”¿ä½œæ¥­': {
            'Q3_1': 'å°æ–¼è¨“ç·´è¡Œæ”¿ä½œæ¥­æ»¿æ„åº¦',
            'Q3_2': 'å°æ–¼è¨“ç·´å ´åœ°ä¹‹æ»¿æ„åº¦',
            'Q3_3': 'å°æ–¼èª²ç¨‹æµç¨‹æ§ç®¡ä¹‹å“è³ªæ»¿æ„åº¦',
            'Q3_4': 'è‹¥æ™‚é–“è¨±å¯é‚„æœ‰å…¶ä»–ç›¸é—œèª²ç¨‹ï¼Œæ‚¨åƒèˆ‡çš„æ„é¡˜åº¦',
        },
        'å››ã€ç°¡ç­”é¡Œ (éå¿…å¡«)': {
            'Q4_1': 'æ‚¨èªç‚ºå¾æœ¬èª²ç¨‹å­¸ç¿’åˆ°ä»€éº¼?',
            'Q4_2': 'å…¶ä»–å»ºè­°',
        }
    };

    // --- Helper Functions ---

    /** é¡¯ç¤ºè‡ªå®šç¾© Modal æç¤ºæ¡† */
    const showModal = (message) => {
        document.getElementById('modalMessage').innerHTML = message;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modalCloseBtn').onclick = () => {
            document.getElementById('modal').classList.add('hidden');
        };
    };

    /** æ¸²æŸ“è©•åˆ†é¸é … (1~5åˆ†) */
    const renderRatingOptions = (name) => {
        const labels = [
            '1: éå¸¸ä¸æ»¿æ„', 
            '2: ä¸æ»¿æ„', 
            '3: æ™®é€š', 
            '4: æ»¿æ„', 
            '5: éå¸¸æ»¿æ„'
        ];
        let html = '<div class="flex justify-between sm:justify-start sm:space-x-4 flex-grow">'; 
        for (let i = 1; i <= 5; i++) {
            html += `
                <div class="relative flex flex-col items-center">
                    <input type="radio" id="${name}-${i}" name="${name}" value="${i}" class="rating-input" required>
                    <label for="${name}-${i}" class="rating-label" title="${labels[i-1]}">${i}</label>
                    <span class="text-xs text-gray-500 mt-1 sm:hidden">${i}</span>
                </div>
            `;
        }
        html += '</div>';
        return html;
    };

    /** æ¸²æŸ“å•å·ä»‹é¢ (Survey View) */
    const renderSurveyView = () => {
        // æ¨™é¡Œåˆ‡æ›
        toggleViewBtn.textContent = 'åˆ‡æ›è‡³å ±å‘Šæ¨¡å¼ (HR èª²é•·)';

        let html = `
            <form id="surveyForm">
                <p class="text-sm text-gray-500 mb-6 border-l-4 border-indigo-400 pl-3 bg-indigo-50 p-2 rounded-md">
                    <strong class="text-indigo-600">å­¸å“¡ ID ${userId.substring(0, 8)}...ï¼š</strong> æ‚¨çš„å¡«å¯«çµæœå°‡è¢«ç”¨æ–¼æ•¸æ“šçµ±è¨ˆï¼Œä¸”ä¸æœƒç›´æ¥é€£çµè‡³æ‚¨çš„èº«ä»½ï¼Œè«‹å®‰å¿ƒå¡«å¯«ã€‚(* æ¨™è¨˜ç‚ºå¿…å¡«)
                </p>

                <div class="space-y-4 mb-10 p-6 bg-gray-50 rounded-lg border">
                    <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2">åŸºæœ¬è³‡è¨Š</h2>

                    <div>
                        <label for="courseId" class="block text-sm font-medium text-gray-700">èª²ç¨‹ç·¨è™Ÿ *</label>
                        <input type="text" id="courseId" name="courseId" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm uppercase" placeholder="ä¾‹å¦‚: ABC101">
                    </div>

                    <div>
                        <label for="jobTitle" class="block text-sm font-medium text-gray-700">å¡«è¡¨äººè·ç­‰ *</label>
                        <select id="jobTitle" name="jobTitle" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="">è«‹é¸æ“‡æ‚¨çš„è·ç­‰</option>
                            ${jobTitles.map(title => `<option value="${title}">${title}</option>`).join('')}
                        </select>
                    </div>
                </div>

                ${Object.entries(questions).slice(0, 3).map(([category, qs]) => `
                    <div class="mb-10">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b-2 border-indigo-500 pb-2">${category}</h2>
                        <div class="space-y-6">
                            ${Object.entries(qs).map(([key, text]) => `
                                <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-100">
                                    <p class="text-base font-medium text-gray-800 mb-3">${key.split('_')[1]}. ${text} *</p>
                                    <div class="flex items-center justify-between mt-2">
                                        <span class="text-sm text-red-500 font-medium whitespace-nowrap hidden sm:inline">1: éå¸¸ä¸æ»¿æ„</span>
                                        ${renderRatingOptions(key)}
                                        <span class="text-sm text-green-600 font-medium whitespace-nowrap hidden sm:inline">5: éå¸¸æ»¿æ„</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}

                <div class="mb-10">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b-2 border-indigo-500 pb-2">${questions['å››ã€ç°¡ç­”é¡Œ (éå¿…å¡«)']['Q4_1'].split('.')[0]}. ç°¡ç­”é¡Œ (éå¿…å¡«)</h2>
                    <div class="space-y-6">
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-100">
                            <label for="Q4_1" class="block text-base font-medium text-gray-800 mb-1">${questions['å››ã€ç°¡ç­”é¡Œ (éå¿…å¡«)']['Q4_1']}</label>
                            <textarea id="Q4_1" name="Q4_1" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="è«‹å¡«å¯«æ‚¨çš„å­¸ç¿’å¿ƒå¾—"></textarea>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-100">
                            <label for="Q4_2" class="block text-base font-medium text-gray-800 mb-1">${questions['å››ã€ç°¡ç­”é¡Œ (éå¿…å¡«)']['Q4_2']}</label>
                            <textarea id="Q4_2" name="Q4_2" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="è«‹å¡«å¯«å…¶ä»–å¯¶è²´å»ºè­°"></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-center pt-5">
                    <button type="submit" class="px-8 py-3 bg-indigo-600 text-white text-xl font-semibold rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out transform hover:scale-[1.02]">
                        æäº¤å•å·
                    </button>
                </div>
            </form>
        `;
        contentDiv.innerHTML = html;
        document.getElementById('surveyForm').addEventListener('submit', handleSurveySubmit);
    };

    /** è™•ç†å•å·æäº¤ (ä½¿ç”¨ fetch é€£æ¥åˆ° Google Apps Script) */
    const handleSurveySubmit = async (event) => {
        event.preventDefault();

        // ** æª¢æŸ¥ APPS_SCRIPT_URL æ˜¯å¦å·²æ›¿æ› **
        if (APPS_SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbxqMfeDnEI0Dt0yR6t_H9k0-5a41YlSl4biiG1iEPJyT0mQ1Uz1WY1CfkBOUZ7RzfVB/exec') {
            showModal(`
                <p class="text-red-600 font-bold">éƒ¨ç½²éŒ¯èª¤ï¼</p>
                <p class="text-sm mt-2">è«‹å…ˆå®Œæˆ Google Apps Script éƒ¨ç½²ï¼Œä¸¦å°‡ HTML ç¨‹å¼ç¢¼ä¸­çš„ APPS_SCRIPT_URL è®Šæ•¸æ›¿æ›æˆæ‚¨å¯¦éš›å–å¾—çš„ /exec ç¶²å€ã€‚</p>
            `);
            return;
        }

        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'æäº¤ä¸­...';

        const data = new FormData(form);
        // ä½¿ç”¨ POST æäº¤ï¼Œä¸¦æŒ‡å®š action ç‚º 'submit_survey'
        const submission = { action: 'submit_survey', userId: userId };

        // æª¢æŸ¥èª²ç¨‹ç·¨è™Ÿæ˜¯å¦å·²å¡«å¯«
        const courseId = data.get('courseId').toUpperCase().trim();
        submission.courseId = courseId;
        submission.jobTitle = data.get('jobTitle');

        // æ”¶é›†è©•åˆ†
        let allRatingsValid = true;
        Object.values(questions).slice(0, 3).forEach(qs => {
            Object.keys(qs).forEach(key => {
                const value = parseInt(data.get(key));
                if (isNaN(value) || value < 1 || value > 5) {
                    allRatingsValid = false;
                }
                submission[key] = value;
            });
        });

        if (!allRatingsValid) {
            submitButton.disabled = false;
            submitButton.textContent = 'æäº¤å•å·';
            showModal("è«‹ç¢ºä¿æ‰€æœ‰æ»¿æ„åº¦å•é¡Œçš†å·²å¡«å¯« (1~5åˆ†)ã€‚");
            return;
        }

        // æ”¶é›†ç°¡ç­”é¡Œ
        submission.Q4_1_text = data.get('Q4_1') || '';
        submission.Q4_2_text = data.get('Q4_2') || '';

        try {
            // ç™¼é€ JSON æ•¸æ“šåˆ° Apps Script Web App
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submission)
            });

            if (!response.ok) {
                // è™•ç†ç¶²è·¯å±¤ç´šçš„éŒ¯èª¤ (ä¾‹å¦‚ 500 ä¼ºæœå™¨éŒ¯èª¤)
                throw new Error(`HTTP éŒ¯èª¤: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                showModal("æ»¿æ„åº¦å•å·å·²æˆåŠŸæäº¤ï¼æ‚¨å¯ä»¥ç¹¼çºŒå¡«å¯«å…¶ä»–èª²ç¨‹çš„å•å·ã€‚");
                form.reset(); // æ¸…ç©ºè¡¨å–®
            } else if (result.status === 'duplicate') {
                showModal(`æ‚¨å·²å¡«å¯«éèª²ç¨‹ç·¨è™Ÿ ${courseId} çš„å•å·ã€‚`);
            } else {
                // è™•ç† Apps Script è¿”å›çš„å…¶ä»–éŒ¯èª¤
                showModal(`
                    æäº¤å¤±æ•—: ${result.message || 'Apps Script è™•ç†éŒ¯èª¤ã€‚'}
                    <p class="text-xs text-gray-500 mt-2">è«‹æª¢æŸ¥ Apps Script çš„åŸ·è¡Œç´€éŒ„ (Execution Logs)ã€‚</p>
                `);
            }

        } catch (error) {
            console.error("æäº¤å•å·æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
            showModal(`
                <p class="text-red-600 font-bold">é€£ç·šå¤±æ•—ï¼</p>
                <p class="text-sm mt-2">è«‹ç¢ºèªæ‚¨çš„ Apps Script URL å’Œéƒ¨ç½²æ¬Šé™ (è¨­ç‚ºã€Œä»»ä½•äººã€)ã€‚</p>
                <p class="text-xs text-gray-500 mt-1">éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
            `);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'æäº¤å•å·';
        }
    };

    // --- å ±å‘Šç›¸é—œ Helper Functions ---
    /** ç²å–å ±å‘Šæ•¸æ“š (ä½¿ç”¨ fetch é€£æ¥åˆ° Google Apps Script) */
    const fetchReportData = async () => {
        if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_WEB_APP_URL') {
             contentDiv.innerHTML = `<div class="text-center py-10 bg-red-100 rounded-lg shadow-inner"><p class="text-xl text-red-700 font-bold">è«‹å…ˆéƒ¨ç½² Google Apps Script ä¸¦è¨­å®š APPS_SCRIPT_URLã€‚</p></div>`;
            return;
        }

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        contentDiv.innerHTML = `
            <div class="flex justify-center items-center h-48">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-xl text-gray-600">æ­£åœ¨å¾ Google Sheets è¼‰å…¥æ•¸æ“š...</span>
            </div>
        `;

        try {
            // Apps Script æ‡‰è™•ç† GET è«‹æ±‚ï¼Œä¸¦å¸¶ä¸Š action åƒæ•¸
            const response = await fetch(`${APPS_SCRIPT_URL}?action=get_reports`);
            if (!response.ok) throw new Error('ä¼ºæœå™¨éŸ¿æ‡‰éŒ¯èª¤');

            const result = await response.json();                        
            if (result.status === 'success') {
                evaluationsData = result.data || [];
                renderReportView(evaluationsData);
            } else {
                throw new Error(result.message || 'ç²å–å ±å‘Šæ•¸æ“šå¤±æ•—');
            }

        } catch (error) {
            console.error("ç²å–å ±å‘Šæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
            contentDiv.innerHTML = `<div class="text-center py-10 bg-red-100 rounded-lg shadow-inner"><p class="text-xl text-red-700 font-bold">è¼‰å…¥å ±å‘Šæ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apps Script è¨­å®šã€‚</p><p class="text-sm text-gray-700 mt-2">éŒ¯èª¤è¨Šæ¯: ${error.message}</p></div>`;
        }
    };

    /** è¨ˆç®—å¹³å‡åˆ†æ•¸ */
    const calculateAverages = (data) => {
        const stats = {};
        const ratingKeys = Object.keys(questions['ä¸€ã€è¬›å¸«ä¹‹å‹ä»»ç¨‹åº¦']).concat(
            Object.keys(questions['äºŒã€èª²ç¨‹å…§å®¹']),
            Object.keys(questions['ä¸‰ã€è¾¦è¨“å–®ä½è¡Œæ”¿ä½œæ¥­'])
        );

        // 1. ä¾èª²ç¨‹ç·¨è™Ÿåˆ†çµ„
        const groupedByCourse = data.reduce((acc, submission) => {
            // Apps Script è¿”å›çš„æ•¸æ“šå¯èƒ½åŒ…å«å¤§å°å¯«ä¸ä¸€çš„ courseIdï¼Œçµ±ä¸€è½‰ç‚ºå¤§å¯«å’Œå»é™¤ç©ºæ ¼
            const id = (submission.courseId || 'N/A').toUpperCase().trim(); 
            if (!acc[id]) {
                acc[id] = { submissions: [], totalCount: 0, sum: {}, openFeedback: [] };
                ratingKeys.forEach(key => acc[id].sum[key] = 0);
            }
            acc[id].submissions.push(submission);
            acc[id].totalCount++;

            // ç´¯è¨ˆè©•åˆ†ç¸½å’Œ
            ratingKeys.forEach(key => {
                // Apps Script è¿”å›çš„æ•¸æ“šå¯èƒ½éƒ½æ˜¯å­—ä¸²ï¼Œéœ€è¦è½‰æ›
                const score = parseFloat(submission[key]); 
                if (!isNaN(score)) {
                    acc[id].sum[key] += score;
                }
            });

            // æ”¶é›†ç°¡ç­”
            if (submission.Q4_1_text) {
                acc[id].openFeedback.push({ type: 'å­¸ç¿’å¿ƒå¾—', text: submission.Q4_1_text, jobTitle: submission.jobTitle });
            }
            if (submission.Q4_2_text) {
                acc[id].openFeedback.push({ type: 'å…¶ä»–å»ºè­°', text: submission.Q4_2_text, jobTitle: submission.jobTitle });
            }

            return acc;
        }, {});

        // 2. è¨ˆç®—å¹³å‡å€¼
        Object.keys(groupedByCourse).forEach(courseId => {
            const courseData = groupedByCourse[courseId];
            stats[courseId] = {
                totalCount: courseData.totalCount,
                averages: {},
                openFeedback: courseData.openFeedback
            };

            ratingKeys.forEach(key => {
                const totalScore = courseData.sum[key];
                stats[courseId].averages[key] = (totalScore / courseData.totalCount).toFixed(2);
            });
        });

        return stats;
    };

    /** æ¸²æŸ“å ±å‘Šä»‹é¢ (Report View) */
    const renderReportView = (data) => {
        // æ¨™é¡Œåˆ‡æ›
        toggleViewBtn.textContent = 'åˆ‡æ›è‡³å•å·æ¨¡å¼ (å­¸å“¡)';

        if (data.length === 0) {
            contentDiv.innerHTML = `
                <div class="text-center py-20 bg-yellow-50 rounded-lg shadow-inner">
                    <svg class="mx-auto h-12 w-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h2 class="mt-4 text-3xl font-bold text-yellow-700">å°šç„¡å•å·è³‡æ–™</h2>
                    <p class="mt-2 text-xl text-gray-600">è«‹ç­‰å¾…å­¸å“¡å¡«å¯«å¾Œï¼Œæ•¸æ“šå°‡å³æ™‚é¡¯ç¤ºæ–¼æ­¤ã€‚</p>
                </div>
            `;
            return;
        }

        const stats = calculateAverages(data);
        const courseIds = Object.keys(stats).sort();

        let html = `
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">æ»¿æ„åº¦èª¿æŸ¥å ±å‘Š (HR èª²é•·)</h2>

            <div class="mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <label for="courseFilter" class="block text-lg font-semibold text-indigo-800 mb-2">é¸æ“‡èª²ç¨‹ç·¨è™ŸæŸ¥çœ‹è©³ç´°å ±å‘Š:</label>
                <select id="courseFilter" class="block w-full border-indigo-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 sm:text-lg">
                    <option value="ALL">-- é¡¯ç¤ºæ‰€æœ‰èª²ç¨‹ (å…± ${data.length} ç­†å›è¦†) --</option>
                    ${courseIds.map(id => `<option value="${id}">${id} (å…± ${stats[id].totalCount} ç­†å›è¦†)</option>`).join('')}
                </select>
            </div>                        
            <div id="reportDetail">
                ${renderCourseDetailReport('ALL', stats)}
            </div>
        `;
        contentDiv.innerHTML = html;

        document.getElementById('courseFilter').addEventListener('change', (e) => {
            const courseId = e.target.value;
            document.getElementById('reportDetail').innerHTML = renderCourseDetailReport(courseId, stats);
        });
    };

    /** æ¸²æŸ“å–®ä¸€æˆ–å…¨éƒ¨èª²ç¨‹çš„è©³ç´°å ±å‘Š */
    const renderCourseDetailReport = (courseId, stats) => {
        let html = '';
        const keys = Object.keys(questions['ä¸€ã€è¬›å¸«ä¹‹å‹ä»»ç¨‹åº¦']).concat(
            Object.keys(questions['äºŒã€èª²ç¨‹å…§å®¹']),
            Object.keys(questions['ä¸‰ã€è¾¦è¨“å–®ä½è¡Œæ”¿ä½œæ¥­'])
        );

        const coursesToDisplay = courseId === 'ALL' ? Object.keys(stats) : [courseId];

        if (coursesToDisplay.length === 0) { 
             return `<p class="text-center text-xl text-red-500 py-10">æŸ¥ç„¡è³‡æ–™</p>`;
        }

        coursesToDisplay.forEach(id => {
            const currentStats = stats[id];
            const isAll = courseId === 'ALL';

            // è™•ç†ç¸½å¹³å‡
            const totalAvgScore = (keys.reduce((sum, key) => sum + parseFloat(currentStats.averages[key]), 0) / keys.length).toFixed(2);
            const totalAvgColor = totalAvgScore >= 4 ? 'bg-green-500' : totalAvgScore >= 3 ? 'bg-yellow-500' : 'bg-red-500';

            html += `
                <div class="${!isAll ? 'mt-8 border-t-4 border-indigo-600 pt-6' : 'mt-4'} p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-2xl font-bold text-indigo-800 mb-4">${isAll ? 'ç¸½é«”è¶¨å‹¢' : `èª²ç¨‹ç·¨è™Ÿ: ${id} è©³ç´°å ±å‘Š`}</h3>
                    <p class="text-gray-700 mb-4">ç¸½å¡«å¯«äººæ•¸: <span class="text-2xl font-extrabold text-indigo-600">${currentStats.totalCount}</span> ç­†</p>

                    <div class="p-4 rounded-lg shadow-md mb-6 ${totalAvgColor} text-white">
                        <p class="text-xl font-medium">èª²ç¨‹æ•´é«”æ»¿æ„åº¦å¹³å‡:</p>
                        <p class="text-4xl font-extrabold">${totalAvgScore} <span class="text-2xl">/ 5.00</span></p>
                    </div>

                    <h4 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">å„é …æ»¿æ„åº¦å¹³å‡å¾—åˆ† (5åˆ†åˆ¶)</h4>
                    <table class="w-full report-table rounded-xl overflow-hidden shadow-lg mb-8">
                        <thead>
                            <tr>
                                <th>é¡åˆ¥/é¡Œç›®</th>
                                <th class="w-1/4">å¹³å‡å¾—åˆ†</th>
                                <th class="w-1/4">æ»¿æ„åº¦è¦–è¦ºåŒ–</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(questions).slice(0, 3).map(([category, qs]) => `
                                <tr>
                                    <td colspan="3" class="bg-indigo-100 text-indigo-700 font-semibold">${category}</td>
                                </tr>
                                ${Object.entries(qs).map(([key, text]) => {
                                    const avg = currentStats.averages[key];
                                    const percentage = (avg / 5) * 100;
                                    const barColor = percentage >= 80 ? 'bg-green-500' : percentage >= 60 ? 'bg-yellow-500' : 'bg-red-500';
                                    return `
                                        <tr>
                                            <td class="text-sm">${text}</td>
                                            <td class="font-bold text-lg">${avg}</td>
                                            <td>
                                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                    <div class="chart-bar ${barColor}" style="width: ${percentage}%" title="${avg}åˆ†"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            `).join('')}
                        </tbody>
                    </table>

                    <h4 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">ç°¡ç­”å›é¥‹ç¸½è¦½</h4>
                    <div class="space-y-4">
                        ${currentStats.openFeedback.length > 0 ? currentStats.openFeedback.map(fb => `
                            <div class="p-4 bg-white rounded-lg shadow-md border-l-4 border-gray-400">
                                <p class="text-sm font-semibold text-gray-600 mb-1">
                                    [${fb.type}] - <span class="text-indigo-600">${fb.jobTitle}</span>
                                </p>
                                <p class="text-gray-800 whitespace-pre-wrap">${fb.text}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500 italic">ç„¡ç°¡ç­”å›é¥‹ã€‚</p>'}
                    </div>
                </div>
            `;
        });

        return html;
    };

    // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
    const initApp = () => {
        // é è¨­åˆ‡æ›åˆ°å•å·æ¨¡å¼
        switchView('survey');
    };

    /** åˆ‡æ›è¦–åœ– */
    const switchView = (view) => {
        currentView = view;
        if (currentView === 'survey') {
            renderSurveyView(); 
        } else {
            fetchReportData(); // åˆ‡æ›åˆ°å ±å‘Šæ¨¡å¼æ™‚ï¼Œå¾ Apps Script ç²å–æ•¸æ“š
        }
    };

    // è¨»å†Šåˆ‡æ›æŒ‰éˆ•äº‹ä»¶
    toggleViewBtn.addEventListener('click', () => {
        if (currentView === 'survey') {
            switchView('report');
        } else {
            switchView('survey');
        }
    });

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    initApp();
</script>
</body>
</html>
