<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™è‚²è¨“ç·´æ»¿æ„åº¦èª¿æŸ¥èˆ‡å ±å‘Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f4f7f9; }
        .rating-input { opacity: 0; position: absolute; width: 1px; height: 1px; overflow: hidden; }
        .rating-label {
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px; border-radius: 9999px; cursor: pointer;
            transition: all 0.2s; font-weight: 600; color: #4b5563; border: 2px solid #e5e7eb;
        }
        .rating-input:checked + .rating-label { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .chart-bar { height: 16px; border-radius: 4px; transition: width 0.5s; }
    </style>
</head>
<body>
<div id="app" class="min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-gray-900">æ•™è‚²è¨“ç·´æ»¿æ„åº¦ç³»çµ±</h1>
        <button id="toggleViewBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700">åˆ‡æ›è‡³å ±å‘Šæ¨¡å¼ (HR èª²é•·)</button>
    </div>
    <div id="content" class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">è¼‰å…¥ä¸­...</div>
</div>

<div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
        <div id="modalMessage" class="text-center text-lg mb-4 font-medium text-gray-800"></div>
        <button id="modalCloseBtn" class="w-full py-2 bg-indigo-600 text-white rounded-md">ç¢ºå®š</button>
    </div>
</div>

<script>
    // ğŸš¨ è«‹å¡«å…¥æ­£ç¢ºçš„ GAS exec URL
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqMfeDnEI0Dt0yR6t_H9k0-5a41YlSl4biiG1iEPJyT0mQ1Uz1WY1CfkBOUZ7RzfVB/exec';

    const userId = 'USER-' + Math.random().toString(36).substring(2, 10).toUpperCase();
    let currentView = 'survey';
    let evaluationsData = [];
    const contentDiv = document.getElementById('content');
    const toggleViewBtn = document.getElementById('toggleViewBtn');

    // 100% å®Œæ•´é¡Œç›®æ–‡å­—
    const questions = {
        'ä¸€ã€è¬›å¸«ä¹‹å‹ä»»ç¨‹åº¦': {
            'Q1_1': 'èˆ‡èª²ç¨‹ä¸»é¡Œç›¸é—œä¹‹ä¸»é¡Œèƒ½åŠ›',
            'Q1_2': 'å£èªè¡¨é”èƒ½åŠ›',
            'Q1_3': 'æ¿€ç™¼å­¸å“¡çš„åƒèˆ‡åŠå­¸ç¿’æ„é¡˜èƒ½åŠ›',
            'Q1_4': 'æˆèª²å…§å®¹èˆ‡èª²ç¨‹ä¸»é¡Œä¹‹å¥‘åˆåº¦',
            'Q1_5': 'å°æ™‚é–“çš„æŒæ¡èƒ½åŠ›'
        },
        'äºŒã€èª²ç¨‹å…§å®¹': {
            'Q2_1': 'å­¸ç¿’åˆ°è§€å¿µèˆ‡æ–°æŠ€å·§çš„æ»¿æ„åº¦',
            'Q2_2': 'è§£æ±ºå·¥ä½œä¸Šæ‰€é¢è‡¨å•é¡Œä¹‹å•Ÿç™¼',
            'Q2_3': 'å°é”æˆå·¥ä½œç›®æ¨™çš„åŠ©ç›Š',
            'Q2_4': 'æ•™æå…§å®¹çš„æ»¿æ„åº¦',
            'Q2_5': 'èª²ç¨‹æ™‚æ•¸å®‰æ’æ»¿æ„åº¦',
            'Q2_6': 'æœ¬èª²ç¨‹é”åˆ°æ‚¨çš„é æœŸæ•ˆæœç¨‹åº¦'
        },
        'ä¸‰ã€è¾¦è¨“å–®ä½è¡Œæ”¿ä½œæ¥­': {
            'Q3_1': 'å°æ–¼è¨“ç·´è¡Œæ”¿ä½œæ¥­æ»¿æ„åº¦',
            'Q3_2': 'å°æ–¼è¨“ç·´å ´åœ°ä¹‹æ»¿æ„åº¦',
            'Q3_3': 'å°æ–¼èª²ç¨‹æµç¨‹æ§ç®¡ä¹‹å“è³ªæ»¿æ„åº¦',
            'Q3_4': 'è‹¥æ™‚é–“è¨±å¯é‚„æœ‰å…¶ä»–ç›¸é—œèª²ç¨‹ï¼Œæ‚¨åƒèˆ‡çš„æ„é¡˜åº¦'
        }
    };

    const showModal = (msg) => {
        document.getElementById('modalMessage').innerHTML = msg;
        document.getElementById('modal').classList.remove('hidden');
    };
    document.getElementById('modalCloseBtn').onclick = () => document.getElementById('modal').classList.add('hidden');

    const renderRatingOptions = (name) => {
        let html = '<div class="flex space-x-3">';
        for (let i = 1; i <= 5; i++) {
            html += `<label><input type="radio" name="${name}" value="${i}" class="rating-input" required><span class="rating-label">${i}</span></label>`;
        }
        return html + '</div>';
    };

    const renderSurveyView = () => {
        toggleViewBtn.textContent = 'åˆ‡æ›è‡³å ±å‘Šæ¨¡å¼ (HR èª²é•·)';
        let html = `<form id="surveyForm" class="space-y-8">
            <div class="p-6 bg-gray-50 rounded-lg border space-y-4">
                <h2 class="text-xl font-bold border-b pb-2">åŸºæœ¬è³‡è¨Š</h2>
                <div><label class="block text-sm font-medium">èª²ç¨‹ç·¨è™Ÿ</label><input type="text" name="courseId" required class="w-full p-3 border rounded uppercase"></div>
                <div><label class="block text-sm font-medium">å¡«è¡¨äººè·ç­‰</label><select name="jobTitle" required class="w-full p-3 border rounded">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="é«˜éšä¸»ç®¡">é«˜éšä¸»ç®¡</option><option value="ä¸­éšä¸»ç®¡">ä¸­éšä¸»ç®¡</option><option value="åŸºå±¤ä¸»ç®¡">åŸºå±¤ä¸»ç®¡</option><option value="ä¸€èˆ¬å“¡å·¥">ä¸€èˆ¬å“¡å·¥</option>
                </select></div>
            </div>`;

        Object.entries(questions).forEach(([cat, qs]) => {
            html += `<div><h2 class="text-2xl font-bold text-gray-700 mb-6 border-b-2 border-indigo-500 pb-2">${cat}</h2><div class="space-y-6">`;
            Object.entries(qs).forEach(([key, text]) => {
                html += `<div class="bg-white p-4 rounded-lg shadow-sm border"><p class="mb-4 font-medium">${text}</p><div class="flex items-center justify-between"><span class="text-sm text-gray-400">ä¸æ»¿æ„</span>${renderRatingOptions(key)}<span class="text-sm text-gray-400">éå¸¸æ»¿æ„</span></div></div>`;
            });
            html += `</div></div>`;
        });

        html += `<div><h2 class="text-2xl font-bold mb-6 border-b-2 border-indigo-500 pb-2">å››ã€ç°¡ç­”é¡Œ</h2><div class="space-y-6">
            <div><label class="block font-medium">å¿ƒå¾—å›é¥‹</label><textarea name="Q4_1" class="w-full p-3 border rounded" rows="3"></textarea></div>
            <div><label class="block font-medium">å…¶ä»–å»ºè­°</label><textarea name="Q4_2" class="w-full p-3 border rounded" rows="3"></textarea></div>
        </div></div><button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-lg text-lg">æäº¤å•å·</button></form>`;
        contentDiv.innerHTML = html;
        document.getElementById('surveyForm').onsubmit = handleSurveySubmit;
    };

    const handleSurveySubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button'); btn.disabled = true; btn.textContent = 'æäº¤ä¸­...';
        const fd = new FormData(e.target);
        const submission = { action: 'submit_survey', userId: userId };
        fd.forEach((v, k) => submission[k === 'Q4_1' ? 'Q4_1_text' : (k === 'Q4_2' ? 'Q4_2_text' : k)] = v);

        try {
            await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(submission), headers: { 'Content-Type': 'text/plain' } });
            showModal("âœ… æäº¤æˆåŠŸï¼"); e.target.reset();
        } catch (err) { showModal("âŒ é€£ç·šç•°å¸¸"); }
        finally { btn.disabled = false; btn.textContent = 'æäº¤å•å·'; }
    };

    const fetchReportData = async () => {
        contentDiv.innerHTML = '<div class="text-center py-20">æ­£åœ¨è¼‰å…¥çµ±è¨ˆæ•¸æ“š...</div>';
        try {
            const res = await fetch(`${APPS_SCRIPT_URL}?action=get_reports`);
            const result = await res.json();
            if (result.status === 'success') { evaluationsData = result.data; renderReportView(evaluationsData); }
        } catch (err) { contentDiv.innerHTML = '<div class="text-red-500 font-bold py-20 text-center">è¼‰å…¥å¤±æ•—ï¼è«‹ç¢ºèª GAS æ¬Šé™ã€‚</div>'; }
    };

    const renderReportView = (data) => {
        toggleViewBtn.textContent = 'åˆ‡æ›è‡³å•å·æ¨¡å¼ (å­¸å“¡)';
        if (data.length === 0) { contentDiv.innerHTML = "ç›®å‰å°šç„¡è³‡æ–™ã€‚"; return; }
        const ids = [...new Set(data.map(d => (d.courseId || 'NA').toUpperCase()))];
        contentDiv.innerHTML = `<h2 class="text-3xl font-bold mb-6">çµ±è¨ˆå ±å‘Š</h2><div class="mb-8"><select id="courseFilter" class="w-full p-3 border rounded"><option value="ALL">æ‰€æœ‰èª²ç¨‹</option>${ids.map(id => `<option value="${id}">${id}</option>`).join('')}</select></div><div id="reportDetail"></div>`;
        document.getElementById('courseFilter').onchange = (e) => renderDetail(e.target.value, data);
        renderDetail('ALL', data);
    };

    const renderDetail = (cid, data) => {
        const detailDiv = document.getElementById('reportDetail');
        const list = cid === 'ALL' ? data : data.filter(d => d.courseId.toUpperCase() === cid);
        let html = `<div class="p-6 bg-gray-50 rounded-lg border shadow-inner"><h3 class="text-xl font-bold text-indigo-800 mb-6">æ¨£æœ¬æ•¸: ${list.length} ç­†</h3>`;
        Object.entries(questions).forEach(([cat, qs]) => {
            html += `<table class="w-full bg-white rounded-lg shadow-md mb-8"><thead><tr><th colspan="3" class="bg-indigo-50 p-3 text-left">${cat}</th></tr></thead><tbody>`;
            Object.entries(qs).forEach(([key, text]) => {
                const avg = (list.reduce((a, b) => a + parseFloat(b[key] || 0), 0) / list.length).toFixed(2);
                html += `<tr><td class="p-3 text-sm w-1/2">${text}</td><td class="p-3 font-bold w-16 text-center">${avg}</td><td class="p-3"><div class="w-full bg-gray-200 rounded-full h-3"><div class="chart-bar bg-blue-500" style="width: ${(avg/5)*100}%"></div></div></td></tr>`;
            });
            html += `</tbody></table>`;
        });
        detailDiv.innerHTML = html + `</div>`;
    };

    toggleViewBtn.onclick = () => {
        if (currentView === 'survey') { currentView = 'report'; fetchReportData(); }
        else { currentView = 'survey'; renderSurveyView(); }
    };

    renderSurveyView();
</script>
</body>
</html>
