<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教育訓練滿意度調查與報告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f4f7f9; }
        .rating-input { opacity: 0; position: absolute; width: 1px; height: 1px; overflow: hidden; }
        .rating-label {
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px; border-radius: 9999px; cursor: pointer;
            transition: all 0.2s; font-weight: 600; color: #4b5563; border: 2px solid #e5e7eb;
        }
        .rating-input:checked + .rating-label { background-color: #3b82f6; color: white; border-color: #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .report-table th { background-color: #eef2ff; color: #4f46e5; text-align: left; padding: 12px; }
        .report-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .chart-bar { height: 15px; border-radius: 4px; transition: width 0.5s ease-out; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-gray-900">教育訓練滿意度系統</h1>
        <button id="toggleViewBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700">切換至報告模式 (HR 課長)</button>
    </div>
    <div id="content" class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">載入中...</div>
</div>

<div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
        <div id="modalMessage" class="text-center text-lg mb-4 font-medium text-gray-800"></div>
        <button id="modalCloseBtn" class="w-full py-2 bg-indigo-600 text-white rounded-md">確定</button>
    </div>
</div>

<script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqMfeDnEI0Dt0yR6t_H9k0-5a41YlSl4biiG1iEPJyT0mQ1Uz1WY1CfkBOUZ7RzfVB/exec';

    const getUserId = () => {
        let id = localStorage.getItem('surveyUserId');
        if (!id) {
            id = 'USER-' + Math.random().toString(36).substring(2, 10).toUpperCase();
            localStorage.setItem('surveyUserId', id);
        }
        return id;
    };

    const userId = getUserId();
    let currentView = 'survey';
    let evaluationsData = [];
    const contentDiv = document.getElementById('content');
    const toggleViewBtn = document.getElementById('toggleViewBtn');

    const jobTitles = ['高階主管', '中階主管', '基層主管', '一般員工'];

    // 100% 恢復您原始的所有題目文字
    const questions = {
        '一、講師之勝任程度': {
            'Q1_1': '與課程主題相關之主題能力',
            'Q1_2': '口語表達能力',
            'Q1_3': '激發學員的參與及學習意願能力',
            'Q1_4': '授課內容與課程主題之契合度',
            'Q1_5': '對時間的掌握能力'
        },
        '二、課程內容': {
            'Q2_1': '學習到觀念與新技巧的滿意度',
            'Q2_2': '解決工作上所面臨問題之啟發',
            'Q2_3': '對達成工作目標的助益',
            'Q2_4': '教材內容的滿意度',
            'Q2_5': '課程時數安排滿意度',
            'Q2_6': '本課程達到您的預期效果程度'
        },
        '三、辦訓單位行政作業': {
            'Q3_1': '對於訓練行政作業滿意度',
            'Q3_2': '對於訓練場地之滿意度',
            'Q3_3': '對於課程流程控管之品質滿意度',
            'Q3_4': '若時間許可還有其他相關課程，您參與的意願度'
        }
    };

    const showModal = (msg) => {
        document.getElementById('modalMessage').innerHTML = msg;
        document.getElementById('modal').classList.remove('hidden');
    };
    document.getElementById('modalCloseBtn').onclick = () => document.getElementById('modal').classList.add('hidden');

    const renderRatingOptions = (name) => {
        let html = '<div class="flex space-x-3">';
        for (let i = 1; i <= 5; i++) {
            html += `<label class="flex flex-col items-center">
                <input type="radio" name="${name}" value="${i}" class="rating-input" required>
                <span class="rating-label">${i}</span>
            </label>`;
        }
        return html + '</div>';
    };

    const renderSurveyView = () => {
        toggleViewBtn.textContent = '切換至報告模式 (HR 課長)';
        let html = `<form id="surveyForm" class="space-y-8">
            <div class="bg-indigo-50 p-4 rounded-md border-l-4 border-indigo-400"><strong>學員 ID:</strong> ${userId.substring(0,8)}... (匿名)</div>
            <div class="p-6 bg-gray-50 rounded-lg border space-y-4">
                <h2 class="text-xl font-bold border-b pb-2">基本資訊</h2>
                <div><label class="block text-sm font-medium">課程編號</label><input type="text" name="courseId" required class="w-full p-3 border rounded uppercase"></div>
                <div><label class="block text-sm font-medium">職等</label><select name="jobTitle" required class="w-full p-3 border rounded">
                    <option value="">請選擇</option>${jobTitles.map(t => `<option value="${t}">${t}</option>`).join('')}
                </select></div>
            </div>`;

        Object.entries(questions).forEach(([cat, qs]) => {
            html += `<div><h2 class="text-2xl font-bold text-gray-700 mb-6 border-b-2 border-indigo-500 pb-2">${cat}</h2><div class="space-y-6">`;
            Object.entries(qs).forEach(([key, text]) => {
                html += `<div class="bg-white p-4 rounded-lg shadow-sm border">
                    <p class="mb-4 font-medium">${text}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400">不滿意</span>
                        ${renderRatingOptions(key)}
                        <span class="text-sm text-gray-400">非常滿意</span>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
        });

        html += `<div><h2 class="text-2xl font-bold mb-6 border-b-2 border-indigo-500 pb-2">四、簡答題 (非必填)</h2>
            <div class="space-y-6">
                <div><label class="block font-medium">您認為從本課程學習到什麼？</label><textarea name="Q4_1" class="w-full p-3 border rounded" rows="3"></textarea></div>
                <div><label class="block font-medium">其他建議</label><textarea name="Q4_2" class="w-full p-3 border rounded" rows="3"></textarea></div>
            </div></div>
            <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-lg text-lg shadow-lg">提交問卷</button></form>`;
        
        contentDiv.innerHTML = html;
        document.getElementById('surveyForm').onsubmit = handleSurveySubmit;
    };

    const handleSurveySubmit = async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.disabled = true; btn.textContent = '提交中...';
        const fd = new FormData(e.target);
        const submission = { action: 'submit_survey', userId: userId };
        fd.forEach((v, k) => {
            if (k === 'Q4_1') submission['Q4_1_text'] = v;
            else if (k === 'Q4_2') submission['Q4_2_text'] = v;
            else submission[k] = v;
        });

        try {
            const res = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(submission),
                headers: { 'Content-Type': 'text/plain' }
            });
            showModal("✅ 提交成功！資料已同步至試算表。");
            e.target.reset();
        } catch (err) {
            showModal("❌ 發生連線異常，請檢查 GAS 設定。");
        } finally {
            btn.disabled = false; btn.textContent = '提交問卷';
        }
    };

    const fetchReportData = async () => {
        contentDiv.innerHTML = '<div class="text-center py-20">正在同步雲端統計數據...</div>';
        try {
            const res = await fetch(`${APPS_SCRIPT_URL}?action=get_reports`);
            const result = await res.json();
            if (result.status === 'success') {
                evaluationsData = result.data;
                renderReportView(evaluationsData);
            }
        } catch (err) {
            contentDiv.innerHTML = '<div class="text-center text-red-500 py-20 font-bold">載入失敗！請確認 GAS 部署是否設為「任何人」。</div>';
        }
    };

    const calculateStats = (data) => {
        const stats = {};
        const keys = [];
        Object.values(questions).forEach(qs => keys.push(...Object.keys(qs)));

        data.forEach(d => {
            const cid = (d.courseId || 'NA').toUpperCase();
            if (!stats[cid]) stats[cid] = { count: 0, sums: {}, feedbacks: [] };
            stats[cid].count++;
            keys.forEach(k => stats[cid].sums[k] = (stats[cid].sums[k] || 0) + parseFloat(d[k] || 0));
            if (d.Q4_1_text) stats[cid].feedbacks.push({type: '心得', text: d.Q4_1_text, job: d.jobTitle});
            if (d.Q4_2_text) stats[cid].feedbacks.push({type: '建議', text: d.Q4_2_text, job: d.jobTitle});
        });
        return stats;
    };

    const renderReportView = (data) => {
        toggleViewBtn.textContent = '切換至問卷模式 (學員)';
        if (data.length === 0) { contentDiv.innerHTML = "目前尚無問卷資料。"; return; }
        
        const stats = calculateStats(data);
        const cids = Object.keys(stats).sort();

        let html = `<h2 class="text-3xl font-bold mb-6">滿意度統計報告</h2>
            <div class="mb-8"><label class="block mb-2 font-bold text-indigo-700">選擇課程編號</label>
            <select id="courseFilter" class="w-full p-3 border rounded-md shadow-sm">
                <option value="ALL">顯示所有課程 (共 ${data.length} 筆回覆)</option>
                ${cids.map(id => `<option value="${id}">${id} (${stats[id].count} 筆回覆)</option>`).join('')}
            </select></div><div id="reportDetail"></div>`;
        
        contentDiv.innerHTML = html;
        document.getElementById('courseFilter').onchange = (e) => renderDetail(e.target.value, stats);
        renderDetail('ALL', stats);
    };

    const renderDetail = (cid, stats) => {
        const detailDiv = document.getElementById('reportDetail');
        const ids = cid === 'ALL' ? Object.keys(stats) : [cid];
        let html = "";
        
        ids.forEach(id => {
            const s = stats[id];
            html += `<div class="mb-10 p-6 bg-gray-50 rounded-lg border shadow-inner">
                <h3 class="text-2xl font-bold text-indigo-800 mb-6">課程: ${id} (回覆數: ${s.count})</h3>`;
            
            Object.entries(questions).forEach(([cat, qs]) => {
                html += `<table class="w-full report-table bg-white rounded-lg shadow-md mb-8">
                    <thead><tr><th colspan="3">${cat}</th></tr></thead><tbody>`;
                Object.entries(qs).forEach(([key, text]) => {
                    const avg = (s.sums[key] / s.count).toFixed(2);
                    const pct = (avg / 5) * 100;
                    html += `<tr>
                        <td class="text-sm w-1/2">${text}</td>
                        <td class="font-bold w-16 text-center text-lg">${avg}</td>
                        <td><div class="w-full bg-gray-200 rounded-full h-3"><div class="chart-bar bg-blue-500" style="width: ${pct}%"></div></div></td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            });

            if (s.feedbacks.length > 0) {
                html += `<h4 class="font-bold mb-4">簡答回饋：</h4><div class="space-y-3">`;
                s.feedbacks.forEach(fb => {
                    html += `<div class="p-3 bg-white rounded border-l-4 border-indigo-400 text-sm">
                        <strong>[${fb.type}] - ${fb.job}:</strong> ${fb.text}
                    </div>`;
                });
                html += `</div>`;
            }
            html += `</div>`;
        });
        detailDiv.innerHTML = html;
    };

    toggleViewBtn.onclick = () => {
        if (currentView === 'survey') { currentView = 'report'; fetchReportData(); }
        else { currentView = 'survey'; renderSurveyView(); }
    };

    renderSurveyView();
</script>
</body>
</html>
